version: "3.8"

services:
    app:
        image: ghcr.io/vovastelmashchuk/velonuxt:${GIT_COMMIT_HASH:}
        dns:
            - 8.8.8.8
            - 8.8.4.4
        environment:
            - NUXT_PUBLIC_GIT_COMMIT_SHA=${GIT_COMMIT_HASH}
            - NUXT_PUBLIC_BASE_URL=https://velonuxt.stelmashchuk.dev
            - NUXT_MONGO_URI=${MONGO_URI}
            - NUXT_JWT_SECRET=${JWT_SECRET}
            - NUXT_PUBLIC_GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
        deploy:
            update_config:
                order: start-first
        networks:
            - infra_reverse-proxy
            - infra_mongo-rs-net
        healthcheck:
            test: ["CMD", "curl", "-f", "http://localhost:3000/api/service/health"]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 10s

networks:
    infra_reverse-proxy:
        external: true
    infra_mongo-rs-net:
        external: true
